# Product Requirements Document: Movement Tracking & Intelligent Path Detection

**Project:** Phone Manager Backend Extension
**Version:** 1.0
**Date:** 2025-11-30
**Author:** Martin Janci
**Status:** Draft

---

## 1. Description

Movement Tracking & Intelligent Path Detection is a backend feature extension for the Phone Manager application. This extension enables comprehensive trip lifecycle management, movement event logging with sensor telemetry, enhanced location tracking with transportation mode context, and map-snapping path correction capabilities.

The system receives movement data from Android clients that perform local trip detection using activity recognition, Bluetooth car detection, and Android Auto integration. The backend stores, processes, and serves this movement data while providing intelligent path correction through external map-matching services.

### Key Capabilities

- **Trip Management**: Full lifecycle tracking of user trips from start to completion
- **Movement Events**: Detailed event logging with sensor telemetry and confidence metrics
- **Transportation Modes**: Classification support for STATIONARY, WALKING, RUNNING, CYCLING, IN_VEHICLE, and UNKNOWN modes
- **Path Correction**: Map-snapping integration to align GPS traces to road/path networks
- **Offline Support**: Idempotent operations supporting client-side storage with sync on connectivity

---

## 2. Deployment Intent

- **Type:** Production SaaS/Application
- **Scale:** Multi-tenant backend serving mobile clients
- **Environment:** Cloud-hosted PostgreSQL with PostGIS extension
- **Integration:** REST API consumed by Android application

---

## 3. Goals

### Primary Goals

| ID | Goal | Success Metric |
|----|------|----------------|
| G1 | Enable trip tracking from client detection | 100% trip data persistence from client submissions |
| G2 | Store movement events with full telemetry | Complete sensor data capture per event |
| G3 | Provide map-snapped path corrections | Path accuracy improvement >80% vs raw GPS |
| G4 | Support offline-first client architecture | Zero data loss with idempotent operations |
| G5 | Maintain existing system performance | <200ms p95 response time for all endpoints |

### Secondary Goals

| ID | Goal | Success Metric |
|----|------|----------------|
| G6 | Enable trip history analysis | Query support for date ranges and filters |
| G7 | Support multiple detection sources | Handle all client detection mechanisms |
| G8 | Provide trip statistics | Aggregate distance, duration, mode breakdown |

---

## 4. Context

### Project Type

**Brownfield Extension** - This PRD extends the existing Phone Manager backend which already provides:

- Device registration and management (Epic 1)
- Location tracking with batch upload (Epic 2)
- Group management for family/friends sharing (Epic 3)
- Geofencing and proximity alerts (Epic 4)

### Existing Infrastructure

| Component | Status | Integration Point |
|-----------|--------|-------------------|
| Device Authentication | Implemented | API key via X-API-Key header |
| Location Storage | Implemented | PostgreSQL with coordinate validation |
| Group Membership | Implemented | Device-to-group relationships |
| Geofences | Implemented | Per-device circular regions |
| Proximity Alerts | Implemented | Device-to-device distance monitoring |

### Technology Stack

- **Language:** Rust 1.83+ (Edition 2024)
- **Framework:** Axum 0.8 with Tokio async runtime
- **Database:** PostgreSQL 16 with SQLx + PostGIS extension
- **New Tables:** movement_events, trips, frequent_locations, common_routes

### Client Architecture

The Android client (developed separately) implements:
- Local trip detection state machine
- Activity recognition integration
- Bluetooth car and Android Auto detection
- Offline storage with sync status tracking
- Background location collection during trips

---

## 5. Functional Requirements

### Trip Management

| ID | Requirement | Priority |
|----|-------------|----------|
| FR-01 | System shall create trips with client-generated localTripId for idempotency | Must Have |
